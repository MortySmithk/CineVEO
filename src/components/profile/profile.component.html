
@if(currentUser(); as user) {
<div class="p-6 md:p-12">
  <div class="max-w-4xl mx-auto">
    <div class="flex flex-col md:flex-row items-center gap-8 mb-12">
      <div class="relative group">
        <img [src]="user.photoURL || 'https://ui-avatars.com/api/?name=' + user.displayName + '&background=1f2937&color=f3f4f6&size=128'" 
             alt="Foto de Perfil" class="w-32 h-32 rounded-full object-cover border-4 border-surface-light">
        <label for="photo-upload-input" class="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
          <i data-lucide="camera" class="w-10 h-10"></i>
        </label>
        <input type="file" id="photo-upload-input" class="hidden" accept="image/png, image/jpeg" (change)="onFileChange($event)">
      </div>
      <div class="text-center md:text-left">
        <h1 class="text-4xl font-bold text-white inline-flex items-center gap-2">
          {{ user.displayName }}
          @if (isAdmin()) {
            <span title="Administrador" class="w-7 h-7 bg-red-600 rounded-full flex items-center justify-center"><i data-lucide="shield-alert" class="w-4 h-4"></i></span>
          } @else if (isPremium()) {
            <span title="Premium" class="w-7 h-7 bg-yellow-500 rounded-full flex items-center justify-center text-black"><i data-lucide="crown" class="w-4 h-4"></i></span>
          }
        </h1>
        <p class="text-text-dim mt-1">{{ userProfile()?.username || 'Nome de usuário não definido' }}</p>
        <p class="text-yellow-400/80 text-sm mt-2">{{ user.email }}</p>
      </div>
    </div>

    <div class="bg-surface p-6 md:p-8 rounded-lg border border-border">
      <h2 class="text-2xl font-bold text-white mb-6">Editar Perfil</h2>
      <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="space-y-6">
        <div>
          <label for="profile-displayname" class="block mb-2 text-sm font-medium text-text-dim">Nome de Exibição</label>
          <input type="text" id="profile-displayname" formControlName="displayName" class="bg-surface-light border border-border text-white text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-3" required>
        </div>
        <div>
          <label for="profile-username" class="block mb-2 text-sm font-medium text-text-dim">Nome de Usuário (Público)</label>
          <input type="text" id="profile-username" formControlName="username" class="bg-surface-light border border-border text-white text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-3" placeholder="seu_usuario">
          <p class="text-xs mt-2 text-text-dim">Será exibido como: @{{ profileForm.get('username')?.value || 'seu_usuario' }}</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-4 pt-4">
          <button type="submit" [disabled]="isSaving() || profileForm.invalid" class="w-full sm:w-auto text-text-dark bg-primary hover:bg-primary-hover font-bold rounded-full text-sm px-8 py-3 text-center disabled:bg-gray-600 disabled:cursor-not-allowed">
            @if(isSaving()) {
              <span>Salvando...</span>
            } @else {
              <span>Salvar Alterações</span>
            }
          </button>
           <button type="button" (click)="resetPassword()" class="w-full sm:w-auto text-white bg-surface-light hover:bg-opacity-80 font-bold rounded-full text-sm px-8 py-3 text-center">Redefinir Senha</button>
        </div>
      </form>
    </div>
  </div>
</div>
}

@if (isCropperModalOpen()) {
  <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-surface p-6 rounded-lg max-w-sm w-full border border-border">
        <h3 class="text-white text-lg font-bold mb-4">Cortar Imagem</h3>
        <div class="mb-4 max-h-[50vh]"><img #cropperImage src="" alt="Imagem para cortar"></div>
        <div class="flex justify-end gap-4">
            <button (click)="isCropperModalOpen.set(false)" class="bg-surface-light hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
            <button (click)="confirmCrop()" [disabled]="isSaving()" class="bg-primary text-text-dark font-bold py-2 px-4 rounded-lg">
                @if(isSaving()){'Salvando...'}@else{'Confirmar'}
            </button>
        </div>
    </div>
  </div>
}
