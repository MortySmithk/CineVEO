<div class="p-6 md:p-12">
  @if(isLoading()) {
    <div class="flex justify-center items-center h-screen">
      <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
    </div>
  } @else if (media(); as mediaItem) {
    <div class="relative min-h-screen">
      <div class="absolute inset-x-0 top-0 h-[60vh]">
        <img [ngSrc]="mediaItem.background" fill priority class="object-cover object-top w-full h-full" alt="Backdrop for {{ mediaItem.title }}">
        <div class="absolute inset-0 bg-gradient-to-t from-background via-background/80 to-transparent"></div>
      </div>
  
      <div class="relative z-10 p-6 md:p-12">
        <div class="flex flex-col md:flex-row gap-8 items-start pt-24 md:pt-48">
          <div class="w-48 md:w-64 flex-shrink-0">
            <img [ngSrc]="mediaItem.poster" width="500" height="750" class="rounded-lg shadow-2xl w-full" alt="Poster for {{ mediaItem.title }}">
          </div>
          <div class="text-white">
            <div class="flex items-center gap-4 mb-2">
              <h1 class="text-4xl lg:text-5xl font-black">{{ mediaItem.title }}</h1>
              @if(mediaItem.rating !== 'N/A') {
                <span class="font-bold text-lg bg-primary text-text-dark px-2.5 py-1 rounded-md">{{ mediaItem.rating }}</span>
              }
            </div>
            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mb-4 text-text-dim text-sm">
              <span>{{ mediaItem.year }}</span>
              @if(mediaItem.genres?.length) {
                <span>•</span>
                <span>{{ mediaItem.genres.map(g => g.name).join(', ') }}</span>
              }
            </div>
            <p class="text-text-dim max-w-3xl leading-relaxed">{{ mediaItem.synopsis }}</p>
          </div>
        </div>
  
        <div class="mt-12">
          <div [class.lg:grid-cols-3]="mediaItem.type === 'series'" class="grid grid-cols-1 lg:grid-cols-1 gap-8">
            
            <div class="lg:col-span-2">
              <div class="aspect-video bg-black rounded-lg overflow-hidden shadow-2xl border border-border">
                @if (playerUrl()) {
                  <iframe [src]="playerUrl()" allowfullscreen class="w-full h-full" frameborder="0"></iframe>
                } @else {
                  <div class="w-full h-full flex items-center justify-center bg-surface">
                    <p class="text-text-dim">Selecione uma opção para assistir</p>
                  </div>
                }
              </div>
              <div class="mt-4 flex flex-wrap items-center gap-3">
                  <button (click)="changeServer(1)" [class.bg-primary]="activeServer() === 1" [class.text-text-dark]="activeServer() === 1" class="server-btn">Servidor 1</button>
                  <button (click)="changeServer(2)" [class.bg-primary]="activeServer() === 2" [class.text-text-dark]="activeServer() === 2" class="server-btn">Servidor 2</button>
              </div>
              @if (activeServer() === 2 && server2Streams().length > 0) {
                <div class="mt-4 flex flex-wrap items-center gap-3">
                  @for (stream of server2Streams(); track stream.url) {
                    <button (click)="selectStream(stream)" 
                            [class.bg-primary]="selectedStream()?.url === stream.url" 
                            [class.text-text-dark]="selectedStream()?.url === stream.url"
                            class="server-btn">
                      {{ stream.description }}
                    </button>
                  }
                </div>
              }
            </div>
  
            @if (mediaItem.type === 'series') {
              <div>
                <div class="flex items-center gap-4 mb-4">
                  <h3 class="text-xl font-bold">Temporadas</h3>
                  <select (change)="selectSeason(mediaItem.seasons[$event.target.value])" class="bg-surface-light border border-border rounded-md px-3 py-1.5 focus:ring-primary focus:border-primary outline-none">
                    @for(season of mediaItem.seasons; track season.id; let i = $index) {
                       @if (season.season_number > 0) {
                        <option [value]="i">{{ season.name }}</option>
                       }
                    }
                  </select>
                </div>
                @if (selectedSeason(); as season) {
                  <div class="bg-surface rounded-lg max-h-[450px] overflow-y-auto p-2 border border-border">
                    @if (season.episodes; as episodes) {
                      <ul class="space-y-1">
                        @for(episode of episodes; track episode.id) {
                          <li>
                            <button (click)="selectEpisode(episode)" class="w-full text-left p-3 rounded-md transition-colors text-sm"
                              [class.bg-primary]="selectedEpisode()?.id === episode.id"
                              [class.text-text-dark]="selectedEpisode()?.id === episode.id"
                              [class.hover:bg-surface-light]="selectedEpisode()?.id !== episode.id">
                              <span class="font-bold">E{{ episode.episode_number }}</span> - {{ episode.name }}
                            </button>
                          </li>
                        }
                      </ul>
                    } @else {
                      <div class="p-4 text-center text-text-dim">Carregando episódios...</div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>